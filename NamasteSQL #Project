Analyzing Credit Card Spending Habits In India

---- Q1.) Write a query to print top 5 cities with highest spends and their percentage contribution of total credit card spends 
SELECT TOP 5 city, total_spend, concat(pct,'%')
FROM (SELECT  DISTINCT(city), 
SUM(amount) OVER (PARTITION BY city) AS total_spend,

(SUM(amount) OVER (PARTITION BY city)*100./SUM(amount) OVER ()) AS pct
FROM credit_card_transactions) a
ORDER BY total_spend DESC

---- Q2.) write a query to print highest spend month and amount spent in that month for each card type
WITH CTE AS (SELECT TOP 1 total_spend, Date
FROM (SELECT DISTINCT DATEPART(MM, transaction_date) AS Date, SUM(amount) AS total_spend
FROM credit_card_transactions
GROUP BY DATEPART(MM, transaction_date)) a
ORDER BY total_spend DESC),

	CTE_2 AS (SELECT MONTH(transaction_date) AS Date, SUM(amount) AS total_spend, card_type
FROM credit_card_transactions
WHERE MONTH(transaction_date) = '1'
GROUP BY MONTH(transaction_date), card_type)

SELECT ct.Date, ctt.total_spend, card_type
FROM CTE ct
INNER JOIN CTE_2 ctt
ON ct.date = ctt.date
ORDER BY ctt.total_spend DESC

---- Q3.) write a query to print the transaction details(all columns from the table) for each card type when
it reaches a cumulative of 1000000 total spends(We should have 4 rows in the o/p one for each car
WITH CTE_1 AS (SELECT *,
SUM(amount) OVER (PARTITION BY card_type ORDER BY amount) AS cumulative_total
FROM credit_card_transactions),

	CTE_2 AS (SELECT *,
DENSE_RANK() OVER (PARTITION BY card_type ORDER BY cumulative_total) AS tots
FROM CTE_1
WHERE cumulative_total >=1000000)

SELECT transaction_id, city, transaction_date, card_type, exp_type, gender, amount, cumulative_total
FROM CTE_2
WHERE tots = 1


---- Q4.) write a query to find city which had lowest percentage spend for gold card type
SELECT TOP 1 city, total_spend, pct 
FROM (SELECT DISTINCT city, 
SUM(amount) OVER (PARTITION BY city) AS total_spend,
(SUM(amount) OVER (PARTITION BY city)*100.0/ SUM(amount) OVER ()) AS pct
FROM credit_card_transactions
WHERE card_type = 'gold') a
ORDER BY pct

---- Q6.) write a query to find percentage contribution of spends by females for each expense type
SELECT DISTINCT exp_type, pct_contribution
FROM (SELECT *,
SUM(amount) OVER (PARTITION BY exp_type, gender)*100/SUM(amount) OVER (PARTITION BY exp_type) AS pct_contribution
FROM credit_card_transactions) a
WHERE gender = 'F'

---- Q7.) which card and expense type combination saw highest month over month growth in Jan-2014
WITH CTE_1 AS (SELECT DISTINCT card_type, exp_type, CONCAT(YEAR(transaction_date), '-' ,MONTH(transaction_date)) AS Date,
SUM(amount) OVER (PARTITION BY card_type, exp_type, DATEPART(YEAR, transaction_date), DATEPART(MONTH, transaction_date)) AS total_amount
FROM credit_card_transactions),


	CTE_2 AS(SELECT card_type, exp_type, date, total_amount,
    LAG(total_amount) OVER (PARTITION BY card_type, exp_type ORDER BY Date ) AS lagged_amount
	FROM CTE_1),

		CTE_3 AS (SELECT card_type, exp_type, date, total_amount, lagged_amount, ((total_amount - lagged_amount)*100.0/total_amount) AS MoM
		FROM CTE_2
		WHERE date = '2014-1'),

			CTE_4 AS (SELECT *,
			DENSE_RANK() OVER(ORDER BY MoM DESC ) AS RANK
			FROM CTE_3)

SELECT card_type, exp_type
FROM CTE_4
WHERE RANK = 1
